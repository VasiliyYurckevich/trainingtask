import groovy.sql.Sql

ext {
    dbName = "mydb"
    dbUser = "SA"
    dbPassword = ""
    dbPort = 9080
    dbHost = "localhost"
    dbFile = "mydb"
    dbUrl = "jdbc:hsqldb:hsql://localhost/mydb;"
    dbDrive = "org.hsqldb.jdbc.JDBCDriver"
}

task startDatabase() {
    group = "develop"
    outputs.upToDateWhen {
        return !available()
    }

    doLast {
        def dbUser = this.dbUser
        def dbPassword = this.dbPassword
        def dbFile = this.dbFile
        def dbName = this.dbName

        def className = "org.hsqldb.server.Server"
        def filePath = "file:${projectDir}/${dbFile};user=${dbUser};password=${dbPassword}"

        def process = buildProcess(className, filePath, dbName)
        wait(process)
        createDatabaseTables(dbUser, dbPassword)
    }
}

def buildProcess(className, filePath, dbName) {
    def javaHome = System.getProperty("java.home")
    def javaBin = javaHome + File.separator + "bin" + File.separator + "java"
    def classpath = project.buildscript.configurations.classpath.asPath

    def builder = new ProcessBuilder(javaBin, "-cp", classpath, className,
            "--database.0", filePath, "--dbname.0", dbName as String)

    builder.redirectErrorStream(true)
    builder.directory(projectDir)
    def process = builder.start()
    process
}

def wait(Process process) {
    def ready = "From command line, use [Ctrl]+[C] to abort abruptly"
    def reader = new BufferedReader(new InputStreamReader(process.getInputStream()))

    def line
    while ((line = reader.readLine()) != null) {
        logger.quiet line
        if (line.contains(ready)) {
            break
        }
    }
}

def createDatabaseTables(dbUser, dbPassword) {

    project.buildscript.configurations.classpath.each { File file ->
        Sql.class.classLoader.addURL(file.toURI().toURL())
    }

    String query = new File("${rootDir.absolutePath}/sql-scripts/create.sql").text

    Sql sql = Sql.newInstance(this.dbUrl, dbUser, dbPassword, this.dbDrive) as Sql
    sql.execute(query)
    sql.close()
}

task dropDatabase() {
    group = "develop"
    outputs.upToDateWhen {
        return available()
    }

    doLast {
        def dbUser = this.dbUser
        def dbPassword = this.dbPassword
        def dbUrl = this.dbUrl
        def dbDrive = this.dbDrive

        ClassLoader loader = Sql.class.classLoader
        project.buildscript.configurations.classpath.each { File file ->
            loader.addURL(file.toURI().toURL())
        }

        String query = new File("${rootDir.absolutePath}/sql-scripts/drop.sql").text

        Sql sql = Sql.newInstance(dbUrl, dbUser, dbPassword, dbDrive) as Sql
        println(sql.execute(query))
        sql.close()
    }
}

task fillDatabase() {
    group = "develop"
    outputs.upToDateWhen {
        return available()
    }
    doLast {
        ClassLoader loader = Sql.class.classLoader
        project.buildscript.configurations.classpath.each { File file ->
            loader.addURL(file.toURI().toURL())
        }

        String query = new File("${rootDir.absolutePath}/sql-scripts/fill.sql").text

        Sql sql = Sql.newInstance(this.dbUrl, this.dbUser, this.dbPassword, this.dbDrive) as Sql
        sql.execute(query)
        sql.close()
    }
}

task stopDatabase() {
    group = "develop"
    outputs.upToDateWhen {
        return available()
    }
    doLast {
        def dbUser = this.dbUser
        def dbPassword = this.dbPassword
        def dbUrl = this.dbUrl
        def dbDrive = this.dbDrive

        ClassLoader loader = Sql.class.classLoader
        project.buildscript.configurations.classpath.each { File file ->
            loader.addURL(file.toURI().toURL())
        }

        Sql sql = Sql.newInstance(dbUrl, dbUser, dbPassword, dbDrive) as Sql
        sql.execute("SHUTDOWN;")
        sql.close()
    }
}

boolean available() {
    try {
        int dbPort = this.dbPort as int
        String dbHost = this.dbHost
        Socket ignored = new Socket(dbHost, dbPort)
        ignored.close()
        return false
    }
    catch (IOException ignored) {
        return true
    }
}